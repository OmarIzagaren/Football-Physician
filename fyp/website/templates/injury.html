{% extends 'base.html' %}

{% block content %}
<meta name="csrf-token" content="{{ csrf_token }}">
<div class = "col-md-6 offset-md-3">
<br/>
<h1>{{ title }}</h1>
<br/>
<form method="POST">
    {% csrf_token %}
    {% if errors_list %}
			<div class="alert alert-warning alert-dismissible fade show" role="alert">
			  Your Form Has Errors
			  {% for error in errors_list %}  
			  		{{ error }}
			  {% endfor %}
			  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
			</div>
		
	{% endif %}

{% if title == 'Edit Injury'%}

    <div style="display: none;">
        {{ form.player }}
    </div>
{% elif form.one_player %}
        <div class="col-auto my-1">
            {{ form.player }}
        </div>
        <br/>
    
{% else %}

    <div style="display: none;">
        {{ form.player }}
    </div>

{% endif %}

    <div class="col-auto my-1">
        {{ form.injury }} 
    </div>
    <br/>
    <div class="form-floating">
        {{ form.injury_start_date }}
        <label for="floatingInput">Injury Start Date</label>
    </div>
    <br/>
    <div class="form-floating" id="id_injury_end_date">
        {{ form.injury_end_date }}
        <label for="floatingInput">Injury End Date</label>
        <br/>
    </div>
    <div>
        <input type="checkbox" id="id_injured" name="injured" {% if form.injured.value %}checked{% endif %}>
        <label for="id_injured">Injured</label>
    </div>
    <br/>
    <button type="submit" class="btn btn-outline-primary">{{ title }}</button>
    {% if title == "Edit Injury" %}
    <button id="delete_injury" type="button" class="btn btn-outline-danger 
    delete-injury" data-injury-id = "{{ injury_id }}">Delete Injury</button>
    {% endif %}

</form>
</div>

<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteModalLabel">Delete Injury</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete this injury? This can <strong>not</strong> be undone.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
        </div>
      </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var injuredCheckbox = document.getElementById('id_injured');
        var deleteInjury = document.getElementById('delete_injury');
        var csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        console.log(injuredCheckbox)

        if (deleteInjury){
            deleteInjury.addEventListener('click', function(){
                var injuryId = deleteInjury.getAttribute('data-injury-id');
                document.getElementById('confirmDelete').setAttribute('data-injury-id', injuryId);
            
                var deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmationModal'));
                deleteModal.show();
            })
        }

        document.getElementById('confirmDelete').addEventListener('click', function() {
            var injuryId = this.getAttribute('data-injury-id');
            
            console.log('Confirmed deletion for injuryId ID:', injuryId);
            
            var xhr = new XMLHttpRequest();
            xhr.open('POST', 'delete_injury/', true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.setRequestHeader('X-CSRFToken', csrfToken); 
            
            xhr.onload = function() {
                if (xhr.status === 200) {

                    console.log('Player deleted successfully');
                    window.location.href = xhr.responseText;
                } else {
                    console.log('Error deleting player');
                }
            };

            xhr.send('injury_id=' + encodeURIComponent(injuryId));
            
            var deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmationModal'));
            deleteModal.hide();
            
        });
    
        toggleInjuryEndDateVisibility();


        injuredCheckbox.addEventListener('change', function () {
            toggleInjuryEndDateVisibility();
        });


        function toggleInjuryEndDateVisibility() {
            var injuryEndDateField = document.getElementById('id_injury_end_date');

            if (injuredCheckbox.checked) {
                injuryEndDateField.style.display = 'none';
            } else {
                injuryEndDateField.style.display = 'block'; 
            }
        }
        
    });
  </script>

{% endblock %}